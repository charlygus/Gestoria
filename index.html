<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner DNI - Validaci√≥n Matem√°tica</title>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; background-color: #f4f7f6; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9em; }
        input, button, textarea { width: 100%; padding: 12px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        
        /* Botones */
        button { background-color: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #0056b3; }
        .btn-cancel { background-color: #dc3545; }
        .btn-generar { background-color: #28a745; margin-top: 10px; padding: 15px; font-size: 18px; }

        /* C√°mara */
        #camera-container { display: none; background: black; padding: 10px; border-radius: 8px; text-align: center; }
        video { width: 100%; max-height: 400px; border-radius: 4px; }
        
        /* Debug */
        #status { padding: 15px; border-radius: 6px; display: none; margin-top: 10px; font-weight: bold; border: 1px solid transparent; }
        .raw-text { font-size: 11px; color: #aaa; height: 80px; font-family: monospace; }
    </style>
</head>
<body>

    <h2 style="text-align:center; color:#333;">Lector DNI Validado</h2>

    <div class="card">
        <label>üì∏ Escanear Documento</label>
        <button type="button" onclick="iniciarCamara()">Abrir C√°mara</button>
        
        <div id="camera-container">
            <video id="video" playsinline autoplay></video>
            <button type="button" onclick="tomarFoto()">Capturar Imagen</button>
            <button type="button" class="btn-cancel" onclick="cerrarCamara()">Cancelar</button>
        </div>
    </div>

    <form id="ventaForm">
        <div class="card">
            <label>üë§ Datos Personales (Filtrados)</label>
            <input type="text" id="nombre" placeholder="Nombre">
            <input type="text" id="apellidos" placeholder="Apellidos">
            <input type="text" id="dni" placeholder="DNI (Validado por Algoritmo)">

            <details>
                <summary style="font-size:12px; cursor:pointer; color:#888;">Ver texto crudo (Debug)</summary>
                <textarea id="textoOCR" class="raw-text" readonly></textarea>
            </details>
        </div>

        <div class="card">
            <label>üöó Veh√≠culo</label>
            <input type="text" id="matricula" placeholder="Matr√≠cula">
            <input type="text" id="modelo" placeholder="Modelo">
            
            <button type="button" class="btn-generar" onclick="generarContrato()">üìÑ GENERAR CONTRATO</button>
        </div>
    </form>

    <div id="status"></div>

    <script>
        // ==========================================
        // üëá PEGA TU URL DEL SCRIPT DE GOOGLE AQU√ç üëá
        // ==========================================
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbznr0RNGh9hLBz5QHE3PJqC1MhC2967dHO0NLIaAaEBxkqxbYcaqsQnBzvVJUhvg3FL/exec"; 
        
        let streamCamara = null;

        // --- FUNCIONES B√ÅSICAS ---
        async function iniciarCamara() {
            document.getElementById('camera-container').style.display = 'block';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                document.getElementById('video').srcObject = stream;
                streamCamara = stream;
            } catch (err) { alert("Error al abrir c√°mara: " + err); }
        }

        function cerrarCamara() {
            if (streamCamara) streamCamara.getTracks().forEach(track => track.stop());
            document.getElementById('camera-container').style.display = 'none';
        }

        function tomarFoto() {
            const video = document.getElementById('video');
            if (!video.srcObject) return;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const imagenBase64 = canvas.toDataURL('image/jpeg', 0.9).split(',')[1]; 
            cerrarCamara();
            enviarAGoogle({ accion: "escanear", imagenDNI: imagenBase64 });
        }

        function generarContrato() {
            const nom = document.getElementById('nombre').value;
            const ape = document.getElementById('apellidos').value;
            const datos = {
                accion: "generar",
                nombre: (nom + " " + ape).trim(),
                dni: document.getElementById('dni').value,
                matricula: document.getElementById('matricula').value,
                modelo: document.getElementById('modelo').value
            };
            enviarAGoogle(datos);
        }

        function enviarAGoogle(datos) {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.innerText = "‚è≥ Procesando... Buscando DNI v√°lido...";
            statusDiv.style.background = "#fff3cd"; statusDiv.style.color = "#856404";

            fetch(URL_SCRIPT, {
                method: "POST", body: JSON.stringify(datos)
            })
            .then(r => r.json())
            .then(data => {
                if (data.estado === "error") throw new Error(data.mensaje);

                if (datos.accion === "escanear") {
                    document.getElementById('textoOCR').value = data.textoDetectado;
                    
                    // EJECUTAR EL CEREBRO MATEM√ÅTICO
                    analizarTextoInteligente(data.textoDetectado);
                    
                    statusDiv.innerText = "‚úÖ Datos filtrados y validados.";
                    statusDiv.style.background = "#d4edda"; statusDiv.style.color = "#155724";
                } else if (datos.accion === "generar") {
                    statusDiv.innerHTML = 'üéâ <a href="' + data.url + '" target="_blank">VER PDF GENERADO</a>';
                    statusDiv.style.background = "#d4edda";
                }
            })
            .catch(e => {
                statusDiv.innerText = "‚ùå Error: " + e.message;
                statusDiv.style.background = "#f8d7da"; statusDiv.style.color = "#721c24";
            });
        }

        // ==========================================
        // üß† CEREBRO V3: MATEM√ÅTICAS + FILTRO MAY√öSCULAS
        // ==========================================
        function analizarTextoInteligente(textoRaw) {
            
            // 1. BUSCAR EL DNI CORRECTO (Usando Matem√°ticas)
            // ==============================================
            // Paso A: Limpiar errores comunes de OCR (O->0, I->1, etc)
            let textoLimpioNumeros = textoRaw.toUpperCase()
                .replace(/O/g, '0').replace(/Q/g, '0')
                .replace(/I/g, '1').replace(/L/g, '1')
                .replace(/S/g, '5').replace(/B/g, '8')
                .replace(/Z/g, '2');

            // Paso B: Buscar TODAS las secuencias de 8 numeros + letra
            // Regex busca: 8 digitos, un separador opcional (- o espacio) y una letra
            const regexCandidatos = /(\d{8})([-\s]?)([A-Z])/g;
            let coincidencias = [...textoLimpioNumeros.matchAll(regexCandidatos)];
            
            let dniValido = "";

            // Paso C: Probar cada candidato con la f√≥rmula del Ministerio
            const letrasDNI = "TRWAGMYFPDXBNJZSQVHLCKE";

            for (const match of coincidencias) {
                let numero = parseInt(match[1], 10); // Los 8 digitos
                let letraLeida = match[3];           // La letra que ley√≥ la camara
                
                // La f√≥rmula m√°gica: El resto de dividir entre 23 nos da la posici√≥n de la letra correcta
                let letraCorrecta = letrasDNI.charAt(numero % 23);

                if (letraCorrecta === letraLeida) {
                    // ¬°BINGO! Coinciden matem√°ticamente. Este es el DNI real.
                    dniValido = match[1] + letraLeida;
                    break; // Dejamos de buscar, ya tenemos al bueno
                }
            }
            
            if (dniValido) {
                document.getElementById('dni').value = dniValido;
            }

            // 2. BUSCAR NOMBRE Y APELLIDOS (Filtro Anti-Min√∫sculas)
            // ==============================================
            const lineas = textoRaw.split('\n');
            let posiblesNombres = [];

            // Palabras prohibidas (si la linea tiene esto, es basura)
            const prohibidas = ["NOM", "COGNOM", "NAIXEMENT", "ESP", "ID", "VALIDEZ", "FECHA", "EQUIPO", "EXPEDICION"];

            for (let linea of lineas) {
                linea = linea.trim();
                if (linea.length < 3) continue; // Lineas muy cortas fuera

                // Regla 1: Si tiene min√∫sculas, FUERA (etiquetas como /nom)
                // /[a-z]/ busca cualquier letra min√∫scula
                if (/[a-z]/.test(linea)) continue;

                // Regla 2: Si tiene n√∫meros, FUERA (fechas, DNI repetido)
                if (/[0-9]/.test(linea)) continue;

                // Regla 3: Si tiene palabras prohibidas, FUERA
                let esProhibida = false;
                for (let palabra of prohibidas) {
                    if (linea.includes(palabra)) esProhibida = true;
                }
                if (esProhibida) continue;

                // Si sobrevive a todo esto, es un nombre candidato
                posiblesNombres.push(linea);
            }

            // Normalmente en el DNI:
            // 1¬∫ linea limpia = APELLIDOS
            // 2¬∫ linea limpia = NOMBRE
            if (posiblesNombres.length > 0) {
                document.getElementById('apellidos').value = posiblesNombres[0]; // El primero suele ser apellido
            }
            if (posiblesNombres.length > 1) {
                document.getElementById('nombre').value = posiblesNombres[1]; // El segundo suele ser nombre
            }
        }
    </script>
</body>
</html>
