<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Venta de Coches</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, button { width: 100%; padding: 10px; box-sizing: border-box; }
        button { background-color: #2c3e50; color: white; border: none; margin-top: 10px; cursor: pointer; }
        button:hover { background-color: #34495e; }
        #camera-container { display: none; margin-bottom: 15px; text-align: center; }
        video { width: 100%; max-height: 300px; background: #000; }
        #status { margin-top: 20px; padding: 10px; background: #f0f0f0; display: none; }
    </style>
</head>
<body>

    <h2>Nuevo Trámite de Venta</h2>

    <div class="input-group">
        <label>Datos del Comprador (DNI)</label>
        <button type="button" onclick="iniciarCamara()">Abrir Cámara para DNI</button>
        
        <div id="camera-container">
            <video id="video" playsinline autoplay></video>
            <button type="button" onclick="tomarFoto()">Capturar y Escanear</button>
            <button type="button" onclick="cerrarCamara()" style="background-color: #c0392b;">Cancelar</button>
        </div>
    </div>

    <form id="ventaForm">
        <div class="input-group">
            <label>Texto extraído del DNI (Raw)</label>
            <textarea id="textoOCR" rows="4" style="width:100%"></textarea>
            <small>Copia y pega los datos correctos abajo si el automático falla.</small>
        </div>

        <div class="input-group">
            <label>Nombre Completo</label>
            <input type="text" id="nombre" placeholder="Nombre Apellidos">
        </div>

        <div class="input-group">
            <label>DNI / NIE</label>
            <input type="text" id="dni" placeholder="12345678X">
        </div>

        <hr>

        <div class="input-group">
            <label>Matrícula Vehículo</label>
            <input type="text" id="matricula" placeholder="0000 BBB">
        </div>

        <div class="input-group">
            <label>Modelo</label>
            <input type="text" id="modelo" placeholder="Ej. Ford Focus">
        </div>

        <button type="button" onclick="generarContrato()">GENERAR CONTRATO</button>
    </form>

    <div id="status"></div>

    <script>
        const URL_SCRIPT = "TU_URL_DEL_WEB_APP_EXEC"; // ¡PEGA AQUÍ TU URL DE APPS SCRIPT!
        let streamCamara = null;

        async function iniciarCamara() {
            document.getElementById('camera-container').style.display = 'block';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                document.getElementById('video').srcObject = stream;
                streamCamara = stream;
            } catch (err) {
                alert("Error al acceder a la cámara: " + err);
            }
        }

        function cerrarCamara() {
            if (streamCamara) {
                streamCamara.getTracks().forEach(track => track.stop());
            }
            document.getElementById('camera-container').style.display = 'none';
        }

        function tomarFoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const imagenBase64 = canvas.toDataURL('image/jpeg').split(',')[1]; // Quitar cabecera data:url
            cerrarCamara();
            
            enviarAGoogle({ accion: "escanear", imagenDNI: imagenBase64 });
        }

        function generarContrato() {
            const datos = {
                accion: "generar",
                nombre: document.getElementById('nombre').value,
                dni: document.getElementById('dni').value,
                matricula: document.getElementById('matricula').value,
                modelo: document.getElementById('modelo').value
            };
            enviarAGoogle(datos);
        }

        function enviarAGoogle(datos) {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.innerText = "Procesando... por favor espera.";

            fetch(URL_SCRIPT, {
                method: "POST",
                body: JSON.stringify(datos)
            })
            .then(r => r.json())
            .then(data => {
                if (datos.accion === "escanear") {
                    document.getElementById('textoOCR').value = data.textoDetectado;
                    statusDiv.innerText = "Escaneo completado. Verifica los datos.";
                    // Aquí podrías añadir expresiones regulares para buscar el DNI automáticamente dentro del texto
                } else if (datos.accion === "generar") {
                    statusDiv.innerHTML = 'Exito! <a href="' + data.url + '" target="_blank">Ver Contrato PDF</a>';
                }
            })
            .catch(e => {
                statusDiv.innerText = "Error: " + e;
            });
        }
    </script>
</body>
</html>
