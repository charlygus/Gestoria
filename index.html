<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner DNI - LÃ³gica Estricta</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 600px; margin: auto; background-color: #f4f7f6; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; font-size: 0.9em; }
        input, button, textarea { width: 100%; padding: 12px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 16px; }
        
        button { background-color: #0d6efd; color: white; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #0b5ed7; }
        .btn-cancel { background-color: #dc3545; }
        .btn-generar { background-color: #198754; font-size: 1.1em; padding: 15px; margin-top: 10px; }

        #camera-container { display: none; background: black; padding: 5px; border-radius: 8px; text-align: center; }
        video { width: 100%; max-height: 400px; }
        
        #status { padding: 15px; border-radius: 6px; display: none; margin-top: 10px; font-weight: bold; }
        .raw-text { font-size: 10px; color: #999; height: 60px; font-family: monospace; border: 1px dashed #ccc; }
    </style>
</head>
<body>

    <h2 style="text-align:center; color:#333;">Lector DNI por Etiquetas</h2>

    <div class="card">
        <label>ðŸ“¸ Escanear Documento</label>
        <button type="button" onclick="iniciarCamara()">Abrir CÃ¡mara</button>
        
        <div id="camera-container">
            <video id="video" playsinline autoplay></video>
            <button type="button" onclick="tomarFoto()">Capturar</button>
            <button type="button" class="btn-cancel" onclick="cerrarCamara()">Cancelar</button>
        </div>
    </div>

    <form id="ventaForm">
        <div class="card">
            <label>ðŸ‘¤ Datos Detectados</label>
            <input type="text" id="nombre" placeholder="Buscando tras NOMBRE/NOM...">
            <input type="text" id="apellidos" placeholder="Buscando tras APELLIDOS/COGNOMS...">
            <input type="text" id="dni" placeholder="Buscando tras DNI/NUM...">

            <details>
                <summary style="font-size:12px; cursor:pointer; color:#888;">Ver texto crudo para comprobar</summary>
                <textarea id="textoOCR" class="raw-text" readonly></textarea>
            </details>
        </div>

        <div class="card">
            <label>ðŸš— VehÃ­culo</label>
            <input type="text" id="matricula" placeholder="MatrÃ­cula">
            <input type="text" id="modelo" placeholder="Modelo">
            <button type="button" class="btn-generar" onclick="generarContrato()">ðŸ“„ GENERAR CONTRATO</button>
        </div>
    </form>

    <div id="status"></div>

    <script>
        // ==========================================
        // ðŸ‘‡ TU URL YA ESTÃ PUESTA AQUÃ ðŸ‘‡
        // ==========================================
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbznr0RNGh9hLBz5QHE3PJqC1MhC2967dHO0NLIaAaEBxkqxbYcaqsQnBzvVJUhvg3FL/exec"; 
        
        let streamCamara = null;

        // --- 1. CÃMARA ---
        async function iniciarCamara() {
            document.getElementById('camera-container').style.display = 'block';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                document.getElementById('video').srcObject = stream;
                streamCamara = stream;
            } catch (err) { alert("Error cÃ¡mara: " + err); }
        }

        function cerrarCamara() {
            if (streamCamara) streamCamara.getTracks().forEach(track => track.stop());
            document.getElementById('camera-container').style.display = 'none';
        }

        function tomarFoto() {
            const video = document.getElementById('video');
            if (!video.srcObject) return;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const imagenBase64 = canvas.toDataURL('image/jpeg', 0.9).split(',')[1]; 
            cerrarCamara();
            enviarAGoogle({ accion: "escanear", imagenDNI: imagenBase64 });
        }

        // --- 2. COMUNICACIÃ“N ---
        function enviarAGoogle(datos) {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.innerText = "â³ Buscando etiquetas 'NOMBRE', 'DNI'...";
            statusDiv.style.background = "#fff3cd"; statusDiv.style.color = "#856404";

            fetch(URL_SCRIPT, {
                method: "POST", body: JSON.stringify(datos)
            })
            .then(r => r.json())
            .then(data => {
                if (data.estado === "error") throw new Error(data.mensaje);

                if (datos.accion === "escanear") {
                    document.getElementById('textoOCR').value = data.textoDetectado;
                    
                    // EJECUTAR LÃ“GICA DE ETIQUETAS
                    analizarPorEtiquetas(data.textoDetectado);
                    
                    statusDiv.innerText = "âœ… Datos extraÃ­dos. Verifica si son correctos.";
                    statusDiv.style.background = "#d4edda"; statusDiv.style.color = "#155724";
                } else if (datos.accion === "generar") {
                    statusDiv.innerHTML = 'ðŸŽ‰ <a href="' + data.url + '" target="_blank">ABRIR PDF</a>';
                    statusDiv.style.background = "#d4edda";
                }
            })
            .catch(e => {
                statusDiv.innerText = "âŒ Error: " + e.message;
                statusDiv.style.background = "#f8d7da"; statusDiv.style.color = "#721c24";
            });
        }

        function generarContrato() {
            const datos = {
                accion: "generar",
                nombre: (document.getElementById('nombre').value + " " + document.getElementById('apellidos').value).trim(),
                dni: document.getElementById('dni').value,
                matricula: document.getElementById('matricula').value,
                modelo: document.getElementById('modelo').value
            };
            enviarAGoogle(datos);
        }

        // ==========================================
        // ðŸ§  CEREBRO: BUSCAR "DETRÃS DE..."
        // ==========================================
        function analizarPorEtiquetas(textoRaw) {
            // Dividir por lÃ­neas y quitar espacios vacÃ­os
            const lineas = textoRaw.split('\n').map(l => l.trim().toUpperCase());
            
            // Variables temporales
            let nombre = "";
            let apellidos = "";
            let dni = "";

            // FunciÃ³n limpieza (quita sÃ­mbolos raros que el OCR pone a veces)
            const limpiar = (txt) => {
                return txt.replace(":", "").replace(".", "").replace("_", "").trim();
            }

            for (let i = 0; i < lineas.length; i++) {
                let linea = lineas[i];

                // 1. APELLIDOS (Busca 'APELLIDOS' o 'COGNOMS')
                if (linea.includes("APELLIDOS") || linea.includes("COGNOMS")) {
                    // Borramos la etiqueta para ver si queda algo en esa misma lÃ­nea
                    let restoLinea = linea.replace("APELLIDOS", "").replace("COGNOMS", "").replace("/", "").trim();
                    
                    if (restoLinea.length > 2) {
                        apellidos = restoLinea; // Estaba en la misma lÃ­nea
                    } else if (i + 1 < lineas.length) {
                        apellidos = lineas[i + 1]; // Estaba en la lÃ­nea siguiente
                    }
                }

                // 2. NOMBRE (Busca 'NOMBRE' o 'NOM')
                // El !linea.includes("PADRES") es para evitar leer los nombres de los padres en DNIs antiguos
                if ((linea.includes("NOMBRE") || linea.includes("NOM")) && !linea.includes("PADRES")) {
                    let restoLinea = linea.replace("NOMBRE", "").replace("NOM", "").replace("/", "").trim();
                    
                    if (restoLinea.length > 2) {
                        nombre = restoLinea; 
                    } else if (i + 1 < lineas.length) {
                        nombre = lineas[i + 1]; 
                    }
                }

                // 3. DNI (Busca 'DNI' o 'NUM')
                if (linea.includes("DNI") || linea.includes("NUM")) {
                    // Primero miramos en esta misma lÃ­nea buscando patrÃ³n 8 nÃºmeros
                    let match = linea.match(/(\d{8})([-\s]?)([A-Z])/);
                    
                    if (match) {
                        dni = match[1] + match[3];
                    } else if (i + 1 < lineas.length) {
                        // Si no, miramos en la siguiente lÃ­nea
                        let matchSig = lineas[i + 1].match(/(\d{8})([-\s]?)([A-Z])/);
                        if (matchSig) {
                            dni = matchSig[1] + matchSig[3];
                        }
                    }
                }
            }

            // --- RED DE SEGURIDAD PARA EL DNI ---
            // Si despuÃ©s de buscar la etiqueta "DNI" no hemos encontrado nada (porque el OCR no leyÃ³ la palabra "DNI")
            // buscamos cualquier patrÃ³n de 8 nÃºmeros + letra en todo el texto.
            if (!dni) {
                // CorrecciÃ³n de O por 0 para la bÃºsqueda general
                let textoLimpio = textoRaw.toUpperCase().replace(/O/g, '0');
                let matchGeneral = textoLimpio.match(/(\d{8})([-\s]?)([A-Z])/);
                if (matchGeneral) {
                    dni = matchGeneral[1] + matchGeneral[3];
                }
            }

            // Asignar valores
            if(nombre) document.getElementById('nombre').value = limpiar(nombre);
            if(apellidos) document.getElementById('apellidos').value = limpiar(apellidos);
            if(dni) document.getElementById('dni').value = dni;
        }
    </script>
</body>
</html>
