<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Venta de Coches - Lector IA</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 600px; margin: auto; background-color: #eaeff2; }
        h2 { text-align: center; color: #2c3e50; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #34495e; font-size: 0.9em; }
        input, button, textarea { width: 100%; padding: 12px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 16px; }
        
        /* Botones */
        button { background-color: #3498db; color: white; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; }
        button:hover { background-color: #2980b9; }
        .btn-cancel { background-color: #e74c3c; }
        .btn-generar { background-color: #27ae60; font-size: 1.1em; padding: 15px; margin-top: 10px; }
        
        /* C√°mara */
        #camera-container { display: none; background: #000; padding: 10px; border-radius: 8px; text-align: center; }
        video { width: 100%; border-radius: 4px; }

        /* Status */
        #status { padding: 15px; border-radius: 6px; display: none; margin-top: 10px; font-weight: bold; }
        .debug-box { font-family: monospace; font-size: 12px; color: #7f8c8d; background: #ecf0f1; border: none; }
    </style>
</head>
<body>

    <h2>üöó Tr√°mite Autom√°tico</h2>

    <div class="card">
        <label>Escanear Documento</label>
        <button type="button" onclick="iniciarCamara()">üì∏ Abrir C√°mara (DNI)</button>
        
        <div id="camera-container">
            <video id="video" playsinline autoplay></video>
            <button type="button" onclick="tomarFoto()">Capturar Imagen</button>
            <button type="button" class="btn-cancel" onclick="cerrarCamara()">Cancelar</button>
        </div>
    </div>

    <form id="ventaForm">
        <div class="card">
            <label>Datos Extra√≠dos (Autocompletado)</label>
            
            <label>Nombre</label>
            <input type="text" id="nombre" placeholder="Nombre detectado...">
            
            <label>Apellidos</label>
            <input type="text" id="apellidos" placeholder="Apellidos detectados...">

            <label>DNI / NIE</label>
            <input type="text" id="dni" placeholder="Ej: 12345678X">

            <details>
                <summary style="cursor:pointer; color:#7f8c8d; margin-bottom:10px;">Ver texto crudo del esc√°ner</summary>
                <textarea id="textoOCR" rows="4" class="debug-box" readonly></textarea>
            </details>
        </div>

        <div class="card">
            <label>Datos del Veh√≠culo</label>
            <input type="text" id="matricula" placeholder="Matr√≠cula (Ej: 0000 BBB)">
            <input type="text" id="modelo" placeholder="Modelo (Ej: Seat Ibiza)">
            
            <button type="button" class="btn-generar" onclick="generarContrato()">üìÑ GENERAR CONTRATO</button>
        </div>
    </form>

    <div id="status"></div>

    <script>
        // ==========================================
        // üëá PEGA TU URL DE GOOGLE APPS SCRIPT AQU√ç üëá
        // ==========================================
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbznr0RNGh9hLBz5QHE3PJqC1MhC2967dHO0NLIaAaEBxkqxbYcaqsQnBzvVJUhvg3FL/exec"; 
        
        let streamCamara = null;

        // --- 1. CONTROL DE C√ÅMARA ---
        async function iniciarCamara() {
            document.getElementById('camera-container').style.display = 'block';
            try {
                // Intenta usar la c√°mara trasera con 'environment'
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                document.getElementById('video').srcObject = stream;
                streamCamara = stream;
            } catch (err) {
                alert("Error c√°mara: " + err);
            }
        }

        function cerrarCamara() {
            if (streamCamara) {
                streamCamara.getTracks().forEach(track => track.stop());
            }
            document.getElementById('camera-container').style.display = 'none';
        }

        function tomarFoto() {
            const video = document.getElementById('video');
            if (!video.srcObject) return;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const imagenBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1]; 
            cerrarCamara();
            
            enviarAGoogle({ accion: "escanear", imagenDNI: imagenBase64 });
        }

        // --- 2. COMUNICACI√ìN Y PROCESAMIENTO ---
        function enviarAGoogle(datos) {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.innerText = "‚è≥ Analizando imagen... (Inteligencia Artificial)";
            statusDiv.style.backgroundColor = "#f1c40f"; // Amarillo
            statusDiv.style.color = "#000";

            fetch(URL_SCRIPT, {
                method: "POST",
                body: JSON.stringify(datos)
            })
            .then(r => r.json())
            .then(data => {
                if (data.estado === "error") {
                    throw new Error(data.mensaje);
                }

                if (datos.accion === "escanear") {
                    // Mostrar texto crudo por si acaso
                    document.getElementById('textoOCR').value = data.textoDetectado;
                    
                    // EJECUTAR LA LIMPIEZA INTELIGENTE
                    procesarTextoDNI(data.textoDetectado);
                    
                    statusDiv.innerText = "‚úÖ Datos extra√≠dos. Revisa si son correctos.";
                    statusDiv.style.backgroundColor = "#2ecc71"; // Verde
                    statusDiv.style.color = "white";
                } else if (datos.accion === "generar") {
                    statusDiv.innerHTML = 'üéâ <a href="' + data.url + '" target="_blank" style="color:white; text-decoration:underline;">ABRIR PDF GENERADO</a>';
                    statusDiv.style.backgroundColor = "#27ae60";
                }
            })
            .catch(e => {
                statusDiv.innerText = "‚ùå Error: " + e.message;
                statusDiv.style.backgroundColor = "#e74c3c";
                statusDiv.style.color = "white";
            });
        }

        function generarContrato() {
            // Unimos nombre y apellidos para el contrato
            const nombreCompleto = document.getElementById('nombre').value + " " + document.getElementById('apellidos').value;
            
            const datos = {
                accion: "generar",
                nombre: nombreCompleto.trim(),
                dni: document.getElementById('dni').value,
                matricula: document.getElementById('matricula').value,
                modelo: document.getElementById('modelo').value
            };
            enviarAGoogle(datos);
        }

        // --- 3. EL CEREBRO DE LA LIMPIEZA (PARSEO) ---
        function procesarTextoDNI(texto) {
            // 1. Convertir todo a may√∫sculas y limpiar espacios raros
            let t = texto.toUpperCase().replace(/\r\n/g, "\n");
            
            // --- ESTRATEGIA PARA EL DNI (Corrige 0 por O, etc) ---
            // Buscamos algo que parezca un DNI aunque tenga letras mal puestas
            // Patr√≥n aproximado: 8 caracteres (numeros o letras parecidas) + 1 letra
            const regexDNI = /([0-9OQIZS]{8})\s*([A-Z])/;
            const matchDNI = t.match(regexDNI);
            
            if (matchDNI) {
                let numeros = matchDNI[1];
                let letra = matchDNI[2];
                
                // Corregir errores t√≠picos de OCR en n√∫meros
                numeros = numeros.replace(/O/g, '0').replace(/Q/g, '0')
                                 .replace(/I/g, '1').replace(/Z/g, '2')
                                 .replace(/S/g, '5').replace(/B/g, '8');
                
                document.getElementById('dni').value = numeros + letra;
            }

            // --- ESTRATEGIA PARA NOMBRES Y APELLIDOS ---
            // El DNI 3.0 suele tener etiquetas: "APELLIDOS" y "NOMBRE"
            
            // Intentar buscar por etiquetas
            let apellidos = "";
            let nombre = "";

            // Buscar linea que contenga "APELLIDOS"
            const partes = t.split('\n'); // Separar por l√≠neas
            
            for (let i = 0; i < partes.length; i++) {
                let linea = partes[i];
                
                // Si encontramos la palabra APELLIDOS, lo siguiente suelen ser los apellidos
                if (linea.includes("APELLIDOS")) {
                    // A veces est√°n en la misma l√≠nea: "APELLIDOS GARCIA PEREZ"
                    let temp = linea.replace("APELLIDOS", "").replace("PRIMER", "").trim();
                    if (temp.length > 2) {
                        apellidos = temp;
                    } else if (partes[i+1]) {
                        // O en la l√≠nea siguiente
                        apellidos = partes[i+1];
                    }
                }
                
                // Si encontramos la palabra NOMBRE
                if (linea.includes("NOMBRE") && !linea.includes("PADRES")) {
                    let temp = linea.replace("NOMBRE", "").trim();
                    if (temp.length > 2) {
                        nombre = temp;
                    } else if (partes[i+1]) {
                        nombre = partes[i+1];
                    }
                }
            }

            // Limpieza final de basura (palabras prohibidas en nombres)
            const limpiarBasura = (str) => {
                return str.replace(/ESPA√ëA|IDESP|DOCUMENTO|NACIONALIDAD|SEXO|[0-9]/g, "").trim();
            };

            if (apellidos) document.getElementById('apellidos').value = limpiarBasura(apellidos);
            if (nombre) document.getElementById('nombre').value = limpiarBasura(nombre);
        }

    </script>
</body>
</html>
