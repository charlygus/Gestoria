<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Venta de Coches</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; background-color: #f4f4f9; }
        h2 { text-align: center; color: #333; }
        .input-group { margin-bottom: 15px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, button, textarea { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        
        /* Botones */
        button { background-color: #2c3e50; color: white; border: none; margin-top: 10px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #34495e; }
        .btn-cancel { background-color: #c0392b; }
        .btn-cancel:hover { background-color: #e74c3c; }
        .btn-generar { background-color: #27ae60; margin-top: 20px; font-size: 18px; }
        .btn-generar:hover { background-color: #2ecc71; }

        /* C√°mara */
        #camera-container { display: none; margin-top: 10px; text-align: center; background: #000; padding: 10px; border-radius: 8px; }
        video { width: 100%; max-height: 300px; border-radius: 4px; }
        
        /* Estado */
        #status { margin-top: 20px; padding: 15px; background: #fff; display: none; border-left: 5px solid #333; border-radius: 4px; }
    </style>
</head>
<body>

    <h2>Gestor√≠a - Cambio de Nombre</h2>

    <div class="input-group">
        <label>1. Escanear DNI del Comprador</label>
        <button type="button" onclick="iniciarCamara()">üì∏ Abrir C√°mara</button>
        
        <div id="camera-container">
            <video id="video" playsinline autoplay></video>
            <button type="button" onclick="tomarFoto()">Capturar Foto</button>
            <button type="button" class="btn-cancel" onclick="cerrarCamara()">Cancelar</button>
        </div>
    </div>

    <form id="ventaForm">
        <div class="input-group">
            <label>Texto le√≠do por la c√°mara (Referencia)</label>
            <textarea id="textoOCR" rows="3" placeholder="Aqu√≠ aparecer√° todo lo que lea la c√°mara..." readonly style="background:#eee;"></textarea>
        </div>

        <div class="input-group">
            <label>üë§ Nombre Completo</label>
            <input type="text" id="nombre" placeholder="Ej: JUAN GARCIA LOPEZ">
            <small style="color:#666;">(Copia el nombre del cuadro de arriba si aparece)</small>
        </div>

        <div class="input-group">
            <label>ü™™ DNI / NIE</label>
            <input type="text" id="dni" placeholder="Se rellenar√° solo al escanear">
        </div>

        <div class="input-group">
            <label>üöó Matr√≠cula Veh√≠culo</label>
            <input type="text" id="matricula" placeholder="0000 BBB">
        </div>

        <div class="input-group">
            <label>üöô Modelo</label>
            <input type="text" id="modelo" placeholder="Ej. Ford Focus">
        </div>

        <button type="button" class="btn-generar" onclick="generarContrato()">üìÑ GENERAR CONTRATO</button>
    </form>

    <div id="status"></div>

    <script>
        // ==========================================
        // ¬°¬° PEGA TU URL DE GOOGLE AQU√ç ABAJO !!
        // ==========================================
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbznr0RNGh9hLBz5QHE3PJqC1MhC2967dHO0NLIaAaEBxkqxbYcaqsQnBzvVJUhvg3FL/exec"; 
        
        let streamCamara = null;

        // 1. FUNCIONES DE C√ÅMARA
        async function iniciarCamara() {
            document.getElementById('camera-container').style.display = 'block';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                document.getElementById('video').srcObject = stream;
                streamCamara = stream;
            } catch (err) {
                alert("No se pudo abrir la c√°mara. Revisa los permisos.");
            }
        }

        function cerrarCamara() {
            if (streamCamara) {
                streamCamara.getTracks().forEach(track => track.stop());
            }
            document.getElementById('camera-container').style.display = 'none';
        }

        function tomarFoto() {
            const video = document.getElementById('video');
            if (!video.srcObject) return;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // Convertir a texto base64 para enviar
            const imagenBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1]; 
            cerrarCamara();
            
            enviarAGoogle({ accion: "escanear", imagenDNI: imagenBase64 });
        }

        // 2. FUNCI√ìN DE GENERAR
        function generarContrato() {
            const datos = {
                accion: "generar",
                nombre: document.getElementById('nombre').value.toUpperCase(),
                dni: document.getElementById('dni').value.toUpperCase(),
                matricula: document.getElementById('matricula').value.toUpperCase(),
                modelo: document.getElementById('modelo').value.toUpperCase()
            };
            
            if(!datos.dni || !datos.matricula) {
                alert("Por favor, rellena al menos DNI y Matr√≠cula.");
                return;
            }

            enviarAGoogle(datos);
        }

        // 3. COMUNICACI√ìN CON GOOGLE (CEREBRO)
        function enviarAGoogle(datos) {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.innerText = "‚è≥ Procesando... espera unos segundos.";
            statusDiv.style.color = "black";
            statusDiv.style.borderColor = "#333";

            fetch(URL_SCRIPT, {
                method: "POST",
                body: JSON.stringify(datos)
            })
            .then(r => r.json())
            .then(data => {
                // A. Si hay error desde Google
                if (data.estado === "error") {
                    statusDiv.innerText = "‚ùå Error: " + data.mensaje;
                    statusDiv.style.color = "red";
                    statusDiv.style.borderColor = "red";
                    return; 
                }
                
                // B. Si es respuesta de ESCANEO
                if (datos.accion === "escanear") {
                    const textoCrudo = data.textoDetectado;
                    document.getElementById('textoOCR').value = textoCrudo; // Mostrar todo
                    
                    // -- L√ìGICA DE DETECCI√ìN AUTOM√ÅTICA DE DNI --
                    // Busca patr√≥n: 8 n√∫meros + separador opcional + 1 letra
                    const regexDNI = /(\d{8})([-\s]?)([A-Z])/i;
                    const match = textoCrudo.match(regexDNI);

                    if (match) {
                        const dniLimpio = match[1] + match[3].toUpperCase(); // Junta numeros y letra
                        document.getElementById('dni').value = dniLimpio;
                        
                        statusDiv.innerText = "‚úÖ ¬°DNI Detectado: " + dniLimpio + "! (Revisa el Nombre arriba)";
                        statusDiv.style.color = "#27ae60";
                        statusDiv.style.borderColor = "#27ae60";
                    } else {
                        statusDiv.innerText = "‚ö†Ô∏è Escaneo completado, pero no vi el DNI claro. B√∫scalo en el texto de arriba.";
                        statusDiv.style.color = "#e67e22";
                        statusDiv.style.borderColor = "#e67e22";
                    }

                // C. Si es respuesta de GENERAR CONTRATO
                } else if (datos.accion === "generar") {
                    statusDiv.innerHTML = 'üéâ <b>¬°Contrato Listo!</b> <br><br> <a href="' + data.url + '" target="_blank" style="background:green; color:white; padding:10px; text-decoration:none; border-radius:5px;">DESCARGAR PDF AQU√ç</a>';
                    statusDiv.style.color = "black";
                    statusDiv.style.borderColor = "green";
                }
            })
            .catch(e => {
                statusDiv.innerText = "‚ùå Error de conexi√≥n: " + e;
                statusDiv.style.color = "red";
                alert("Error de conexi√≥n. Revisa tu internet o la URL del script.");
            });
        }
    </script>
</body>
</html>
